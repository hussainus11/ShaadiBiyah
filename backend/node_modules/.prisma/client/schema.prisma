// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  VENDOR
  ADMIN
}

enum BookingStatus {
  PENDING
  APPROVED
  REJECTED
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum VendorCategory {
  VENUE
  CATERER
  PHOTOGRAPHER
  DECORATOR
  MAKEUP_ARTIST
  DJ
  TRANSPORT
  FLORIST
  WEDDING_PLANNER
  OTHER
}

enum VerificationStatus {
  PENDING
  DOCUMENT_SENT
  DOCUMENT_SIGNED
  VERIFIED
  REJECTED
  EXPIRED
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  password     String
  firstName    String
  lastName     String
  phone        String?
  role         UserRole  @default(USER)
  isVerified   Boolean   @default(false)
  profileImage String?
  weddingDate  DateTime?
  budget       Float?
  location     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  bookings         Booking[]
  sentMessages     Message[]      @relation("SentMessages")
  receivedMessages Message[]      @relation("ReceivedMessages")
  reviews          Review[]
  notifications    Notification[]
  chatSessions     ChatSession[]  @relation("UserChatSessions")
  vendor           Vendor?

  @@map("users")
}

model Vendor {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  businessName String
  category     VendorCategory
  description  String
  location     String
  phone        String
  email        String
  website      String?

  // Business Details
  experience   Int     @default(0)
  rating       Float   @default(0)
  totalReviews Int     @default(0)
  isVerified   Boolean @default(false)
  isActive     Boolean @default(true)

  // Verification Status
  verificationStatus VerificationStatus @default(PENDING)
  documentSignedAt   DateTime?
  verificationNotes  String?

  // Pricing
  basePrice  Float?
  priceRange String?

  // Images
  profileImage String?
  gallery      String[]

  // Availability
  availability Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  bookings              Booking[]
  services              Service[]
  reviews               Review[]
  chatSessions          ChatSession[]                @relation("VendorChatSessions")
  verificationDocuments VendorVerificationDocument[]
  dynamicFields         VendorDynamicField[]

  @@map("vendors")
}

model Service {
  id       String @id @default(cuid())
  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  name        String
  description String
  price       Float
  duration    Int? // in hours
  maxCapacity Int?
  includes    String[]
  addOns      Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  bookings Booking[]

  @@map("services")
}

model Booking {
  id        String @id @default(cuid())
  userId    String
  vendorId  String
  serviceId String

  user    User    @relation(fields: [userId], references: [id])
  vendor  Vendor  @relation(fields: [vendorId], references: [id])
  service Service @relation(fields: [serviceId], references: [id])

  // Booking Details
  eventDate       DateTime
  eventTime       String
  eventDuration   Int
  guestCount      Int?
  location        String?
  specialRequests String?

  // Pricing
  basePrice       Float
  additionalCosts Float @default(0)
  totalAmount     Float

  // Status
  status        BookingStatus @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)

  // Timestamps
  requestedAt DateTime  @default(now())
  approvedAt  DateTime?
  confirmedAt DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  payments Payment[]
  messages Message[]

  @@map("bookings")
}

model Payment {
  id        String  @id @default(cuid())
  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id])

  amount          Float
  currency        String  @default("USD")
  paymentMethod   String // stripe, easypaisa, jazzcash
  transactionId   String?
  gatewayResponse Json?

  status PaymentStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payments")
}

model Message {
  id         String  @id @default(cuid())
  senderId   String
  receiverId String
  bookingId  String?

  sender   User     @relation("SentMessages", fields: [senderId], references: [id])
  receiver User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  booking  Booking? @relation(fields: [bookingId], references: [id])

  content     String
  messageType String   @default("text") // text, image, file
  attachments String[]

  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("messages")
}

model ChatSession {
  id       String @id @default(cuid())
  userId   String
  vendorId String

  user   User   @relation("UserChatSessions", fields: [userId], references: [id])
  vendor Vendor @relation("VendorChatSessions", fields: [vendorId], references: [id])

  lastMessageAt DateTime @default(now())
  isActive      Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, vendorId])
  @@map("chat_sessions")
}

model Review {
  id       String @id @default(cuid())
  userId   String
  vendorId String

  user   User   @relation(fields: [userId], references: [id])
  vendor Vendor @relation(fields: [vendorId], references: [id])

  rating  Int // 1-5
  comment String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, vendorId])
  @@map("reviews")
}

model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  title   String
  message String
  type    String // booking, message, payment, system
  isRead  Boolean @default(false)

  createdAt DateTime @default(now())

  @@map("notifications")
}

model WeddingChecklist {
  id     String @id @default(cuid())
  userId String

  title       String
  description String?
  category    String
  isCompleted Boolean   @default(false)
  dueDate     DateTime?
  priority    String    @default("medium") // low, medium, high

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("wedding_checklists")
}

model AIConversation {
  id     String @id @default(cuid())
  userId String

  messages Json // Array of conversation messages
  context  Json? // Wedding planning context

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ai_conversations")
}

// Matrimonial module
enum Gender {
  MALE
  FEMALE
  OTHER
}

model MatrimonialProfile {
  id                 String    @id @default(cuid())
  name               String
  email              String    @unique
  phone              String?
  gender             Gender
  dateOfBirth        DateTime?
  age                Int?
  city               String
  profession         String
  education          String
  religion           String
  height             String?
  bio                String?
  interests          String[]
  photos             String[]
  familyBackground   String?
  partnerPreferences String?
  isVerified         Boolean   @default(false)
  isOnline           Boolean   @default(false)
  lastSeen           DateTime?
  compatibilityScore Int       @default(0)
  // Simple flags (for demo); in production use relation tables per user
  isInterested       Boolean   @default(false)
  isMatched          Boolean   @default(false)
  isBlocked          Boolean   @default(false)

  // Relations
  sentMessages     MatrimonialMessage[] @relation("SentMatrimonialMessages")
  receivedMessages MatrimonialMessage[] @relation("ReceivedMatrimonialMessages")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("matrimonial_profiles")
}

model MatrimonialMessage {
  id            String             @id @default(cuid())
  fromProfileId String
  toProfileId   String
  fromProfile   MatrimonialProfile @relation("SentMatrimonialMessages", fields: [fromProfileId], references: [id])
  toProfile     MatrimonialProfile @relation("ReceivedMatrimonialMessages", fields: [toProfileId], references: [id])
  content       String
  createdAt     DateTime           @default(now())

  @@map("matrimonial_messages")
}

model VendorVerificationDocument {
  id       String @id @default(cuid())
  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  documentType    String // "TERMS_AND_CONDITIONS", "SERVICE_AGREEMENT", "VERIFICATION_FORM"
  documentTitle   String
  documentContent String // HTML content of the document
  documentHash    String // Hash for integrity verification

  // Signing process
  signingToken   String    @unique
  tokenExpiresAt DateTime
  signedAt       DateTime?
  signatureData  Json? // Digital signature data

  // Document status
  status    String  @default("PENDING") // PENDING, SENT, SIGNED, EXPIRED
  ipAddress String?
  userAgent String?

  // Admin review
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("vendor_verification_documents")
}

model VendorDynamicField {
  id       String @id @default(cuid())
  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  fieldName    String // Internal field name (e.g., "customField1")
  fieldLabel   String // Display label (e.g., "Special Equipment")
  fieldType    String // "text", "email", "textarea", "number", "select", "checkbox"
  fieldOptions String[] // Options for select fields
  fieldValue   String? // Stored value
  isRequired   Boolean  @default(false)
  displayOrder Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("vendor_dynamic_fields")
}
